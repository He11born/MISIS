# --- –ß–ê–°–¢–¨ 1: –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ò–ú–ü–û–†–¢–´ ---
import pandas as pd
import os
import sys

FILE_NAME = '—Ä–∞–∑—Ä–∞–±.csv'
# --- –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –°–û–°–¢–û–Ø–ù–ò–Ø ---
# –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ò–î –ù–æ–º–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ user_data
USER_ID_KEY = 'registered_id'

# –¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫
BTN_CHECK_PASSES = 'üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤'
BTN_CHANGE_ID = '‚úèÔ∏è –°–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä'
from telegram import ReplyKeyboardMarkup, ReplyKeyboardRemove

# 1. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ (–ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ò–î)
def get_main_keyboard():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Å–º–µ–Ω—ã –ò–î."""
    keyboard = [[BTN_CHECK_PASSES], [BTN_CHANGE_ID]]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)

# 2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞-–∑–∞–≥–ª—É—à–∫–∞ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ò–î)
def remove_keyboard():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã."""
    return ReplyKeyboardRemove()


# ------------------------------------

def load_data():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV-—Ñ–∞–π–ª–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å
    {–ò–î_–ù–æ–º–µ—Ä: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø—Ä–æ–ø—É—Å–∫–æ–≤}.

    –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ (—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ—Ç —Å—Ç–æ–ª–±—Ü–æ–≤), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.
    """

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    if not os.path.exists(FILE_NAME):
        print(f"–û—à–∏–±–∫–∞: –§–∞–π–ª '{FILE_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å.")
        return {}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é

    # 2. –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º TRY-EXCEPT –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ Pandas
    try:
        # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤ pd.read_csv:
        df = pd.read_csv(FILE_NAME, encoding='latin1', sep=';')

        # –û—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
        df.columns = df.columns.str.strip()
        ID_COL = 'ID –ù–æ–º–µ—Ä'
        PASS_COL = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤'

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–µ—Ä–µ–¥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
        if ID_COL not in df.columns or PASS_COL not in df.columns:
            print(f"–û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã '{ID_COL}' –∏–ª–∏ '{PASS_COL}'.")
            return {}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å, –µ—Å–ª–∏ –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤

        df[ID_COL] = df[ID_COL].astype(str).str.strip()

        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è. –≠—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ —É –≤–∞—Å –±—ã–ª–∞ –æ—à–∏–±–∫–∞,
        # –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ 'df' —Ç–æ—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
        data_dict = df.set_index(ID_COL)[PASS_COL].to_dict()

        print("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
        return data_dict

    except Exception as e:
        # !!! –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—á–∞—Ç–∞–µ–º –ø–æ–ª–Ω—É—é –æ—à–∏–±–∫—É !!!
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò: {e}", file=sys.stderr)
        return {}


# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
STUDENT_DATA = load_data()


# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
print(f"–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {list(STUDENT_DATA.items())[:2]}")
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import logging

# --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
# !!! –ó–ê–ú–ï–ù–ò –≠–¢–û –ù–ê –°–í–û–ô –¢–û–ö–ï–ù !!!
TOKEN = "8593691820:AAGVVUwjqPzIHtx8auVIOkwM6_1NsYw7w0w"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)


# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ---
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ò–î."""
    user_id = context.user_data.get(USER_ID_KEY)

    if user_id:
        # –ï—Å–ª–∏ –ò–î —É–∂–µ –µ—Å—Ç—å
        reply_text = (
            f'–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –í–∞—à —Ç–µ–∫—É—â–∏–π ID –ù–æ–º–µ—Ä: **{user_id}**.\n'
            '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤" –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.'
        )
        keyboard = get_main_keyboard()
    else:
        # –ï—Å–ª–∏ –ò–î –Ω–µ—Ç, –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏
        reply_text = (
            '–ü—Ä–∏–≤–µ—Ç! üëã –Ø –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ –í–£–ó–µ.\n'
            '–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, **–≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π ID –ù–æ–º–µ—Ä**(–Ω–æ–º–µ—Ä —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –±–∏–ª–µ—Ç–∞).'
        )
        keyboard = remove_keyboard()

    await update.message.reply_text(reply_text, reply_markup=keyboard, parse_mode='Markdown')
async def change_id_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–º–µ–Ω—ã ID –ù–æ–º–µ—Ä–∞."""
    await update.message.reply_text(
        '–•–æ—Ä–æ—à–æ, –≤–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–≤—ã–π ID –ù–æ–º–µ—Ä.',
        reply_markup=remove_keyboard()
    )
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ò–î, —á—Ç–æ–±—ã –±–æ—Ç –∂–¥–∞–ª –Ω–æ–≤—ã–π –≤–≤–æ–¥
    if USER_ID_KEY in context.user_data:
        del context.user_data[USER_ID_KEY]


async def check_id(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ (–∫–∞–∫ –ò–î) –∏–ª–∏ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏."""
    user_input = update.message.text.strip()

    # --- –°–¶–ï–ù–ê–†–ò–ô 1: –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏" ---
    if user_input == BTN_CHECK_PASSES:
        search_id = context.user_data.get(USER_ID_KEY)
        if not search_id:
            # –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –ò–î –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–≥–æ —Å–Ω–æ–≤–∞
            return await start_command(update, context)
            # –ï—Å–ª–∏ –ò–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –Ω–∏–º
        pass  # –ò–¥–µ–º –¥–∞–ª—å—à–µ –Ω–∞ –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö

    # --- –°–¶–ï–ù–ê–†–ò–ô 2: –í–≤–µ–¥–µ–Ω –ò–î –ù–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–°–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä" ---
    elif user_input == BTN_CHANGE_ID:
        return await change_id_handler(update, context)

    # --- –°–¶–ï–ù–ê–†–ò–ô 3: –í–≤–µ–¥–µ–Ω –Ω–æ–≤—ã–π –ò–î –ù–æ–º–µ—Ä (—Ç–µ–∫—Å—Ç) ---
    else:
        search_id = str(user_input)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π –ò–î –≤ –±–∞–∑–µ
        if search_id not in STUDENT_DATA:
            message = (
                f'‚ùå ID –ù–æ–º–µ—Ä **{search_id}** –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—à–µ–π –±–∞–∑–µ.\n'
                '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'
            )
            return await update.message.reply_text(message, parse_mode='Markdown')

        # –ï—Å–ª–∏ –ò–î –Ω–∞–π–¥–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context.user_data[USER_ID_KEY] = search_id

        message = (
            f'‚úÖ –í–∞—à ID –ù–æ–º–µ—Ä **{search_id}** —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.\n'
            '–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤".'
        )
        await update.message.reply_text(
            message,
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )

    # --- –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê –ü–†–û–ü–£–°–ö–û–í ---
    if search_id in STUDENT_DATA:
        absences = STUDENT_DATA[search_id]

        message = (
            f'‚úÖ –í–∞—à —Ç–µ–∫—É—â–∏–π ID –ù–æ–º–µ—Ä: **{search_id}**\n'
            f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤ (–≤ —á–∞—Å–∞—Ö): **{absences}**.'
        )
    else:
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (—ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–¥–∫–æ), –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –ò–î —Å–Ω–æ–≤–∞
        message = (
            '‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π ID –ù–æ–º–µ—Ä —Å–Ω–æ–≤–∞.'
        )

    await update.message.reply_text(message, parse_mode='Markdown', reply_markup=get_main_keyboard())


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /help."""
    await update.message.reply_text(
        '–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏, –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π **ID –ù–æ–º–µ—Ä**.\n'
        '–ü—Ä–∏–º–µ—Ä: `2506290` –∏–ª–∏ `2506270`.'
    )


# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---

def main() -> None:
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞."""

    # 1. –°–æ–∑–¥–∞–µ–º Application –∏ –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–∫–µ–Ω
    application = Application.builder().token(TOKEN).build()  # <-- –ó–¥–µ—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç

    # 2. –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_id))

    # 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ run_polling)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    application.run_polling(allowed_updates=Update.ALL_TYPES)  # <-- –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è


if __name__ == "__main__":
    if STUDENT_DATA:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        main()
    else:
        print("–ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª.")
